<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Agenda - Salas de Reunião</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet"/>
  <style>
    :root {
      --primary-color: #ffc107; --dark-bg: #000; --light-bg: #111; --darker-bg: #1a1a1a;
      --text-color: #fff; --text-muted: #aaa; --border-color: #333; --success-color: #28a745; --danger-color: #dc3545;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background-color: var(--dark-bg); color: var(--text-color); }
    .fullscreen-center { height: 100vh; display: flex; justify-content: center; align-items: center; }
    header { background-color: var(--dark-bg); padding: 1rem 2rem; border-bottom: 1px solid var(--primary-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .header-logo { display: flex; align-items: center; gap: 10px; }
    .header-logo img { height: 40px; }
    header h2 { margin: 0; color: var(--primary-color); font-size: 1.5rem; }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .badge { background: var(--primary-color); color: var(--dark-bg); padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
    .badge.admin { background: var(--danger-color); color: white; }
    .badge.viewer { background: #007bff; color: white; }
    header button { background: var(--border-color); color: var(--primary-color); border: 1px solid var(--primary-color); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-weight: bold; }
    header button:hover { background: var(--primary-color); color: var(--dark-bg); }
    .tabs { display: flex; gap: 10px; margin: 1rem 2rem 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
    .tab-button { padding: 0.6rem 1.2rem; background: var(--border-color); color: var(--primary-color); border: none; border-radius: 6px 6px 0 0; cursor: pointer; transition: all 0.3s; font-weight: bold; }
    .tab-button.active { background: var(--primary-color); color: var(--dark-bg); }
    .view { display: none; margin: 1rem 2rem; }
    .view.active { display: block; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--primary-color); }
    input, select, textarea { width: 100%; padding: 10px; background: #222; color: white; border: 1px solid #444; border-radius: 6px; font-size: 14px; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 5px rgba(255, 193, 7, 0.5); }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .btn-primary { background: var(--primary-color); color: var(--dark-bg); }
    .btn-primary:hover { background: #ffd700; }
    .error { color: #ef4444; font-size: 14px; margin-top: 10px; text-align: center; }
    #loginScreen .login-box { display: flex; flex-direction: column; align-items: center; gap: 25px; background-color: var(--dark-bg); padding: 40px; border-radius: 12px; box-shadow: 0 0 15px rgba(243, 227, 2, 0.8); max-width: 350px; width: 90%; }
    .rooms-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
    .room-card { background: var(--light-bg); border-radius: 10px; border: 1px solid var(--primary-color); }
    .room-header { background: #222; padding: 15px; border-bottom: 1px solid var(--primary-color); display: flex; justify-content: space-between; align-items: center; }
    .room-title { font-size: 18px; font-weight: 600; color: var(--primary-color); }
    .room-content { padding: 15px; max-height: 60vh; overflow-y: auto; }
    .meeting-item { background: #222; border-left: 4px solid; border-radius: 8px; padding: 15px; margin-bottom: 10px; position: relative; }
    .meeting-time { font-weight: 600; color: var(--primary-color); margin-bottom: 5px; }
    .meeting-details div { margin-bottom: 5px; }
    .meeting-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
    .btn-small { padding: 5px 10px; font-size: 12px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
    .modal-content { background-color: var(--light-bg); margin: 5% auto; padding: 30px; border-radius: 10px; border: 1px solid var(--primary-color); width: 95%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--primary-color); padding-bottom: 10px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .state-message { text-align: center; padding: 40px; color: var(--text-muted); }
    .state-message i { font-size: 40px; margin-bottom: 15px; display: block; }
    .filtros-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; align-items: end; margin-bottom: 20px; padding: 20px; background: var(--light-bg); border-radius: 10px; border: 1px solid var(--primary-color); }
    .relatorio-container { background: var(--light-bg); border-radius: 10px; border: 1px solid var(--primary-color); padding: 20px; margin-top: 20px; min-height: 300px; overflow-x: auto; }
    .tabela-relatorio { width: 100%; border-collapse: collapse; font-size: 14px; }
    .tabela-relatorio th, .tabela-relatorio td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
    .tabela-relatorio th { background: var(--border-color); color: var(--primary-color); position: sticky; top: 0; }
    #calendar {
      background: var(--light-bg);
      padding: 1rem;
      border-radius: 10px;
      border: 1px solid var(--primary-color);
      max-width: 1100px;
      margin: auto;
      color: white;
    }
    .fc-event, .fc-event-dot {
      background: rgba(255, 193, 7, 0.25) !important;
      border: 1px solid rgba(255, 193, 7, 0.5) !important;
    }
    .fc-event-main {
      color: #ffffff !important;
      font-weight: 500;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
    }
    .fc-event-title {
        white-space: normal !important;
        overflow: visible !important;
    }
    .fc-event-time {
      font-weight: bold;
    }
    .fc-daygrid-event-dot {
      border-color: var(--primary-color) !important;
    }
    .fc-button { background-color: var(--border-color) !important; color: var(--primary-color) !important; border-color: var(--primary-color) !important; }
    .fc-button-active, .fc-button:hover { background-color: var(--primary-color) !important; color: var(--dark-bg) !important; }
    .fc-daygrid-day.fc-day-today { background-color: rgba(255, 255, 255, 0.15) !important; }
    .participantes-container { margin-top: 1rem; display: grid; gap: 10px; max-height: 150px; overflow-y: auto; padding: 10px; background: var(--darker-bg); border-radius: 6px; }
    @keyframes fa-spin { from { transform: rotate(0deg); } to { transform: rotate(359deg); } }
    @media (max-width: 768px) { .form-row, .rooms-container, .filtros-container { grid-template-columns: 1fr; } }
    .meeting-item {
      background: var(--darker-bg);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid;
      position: relative;
    }
    .meeting-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .meeting-time {
      color: var(--primary-color);
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    .meeting-details {font-size: 0.9em;}
    .meeting-details div {
      margin-bottom: 5px;
    }
    .meeting-actions {
      display: flex;
      gap: 5px;
    }
    .meeting-status {
      font-size: 0.8em;
      font-weight: bold;
    }
    .fc-theme-standard .fc-list-day-cushion { background-color: var(--darker-bg); }
    .fc-list-day-text, .fc-list-day-side-text { color: var(--primary-color) !important; font-weight: bold; }
    .fc-list-event-time { color: var(--text-muted); }
    .fc-list-event-title, .fc-list-event-title a { color: var(--text-color) !important; }
    .fc-list-event:hover td { background-color: #2a2a2a !important; }
    .fc-list-table { border-color: var(--border-color); }
  </style>
</head>
<body>
  
  <div id="loginScreen" class="fullscreen-center">
    <div class="login-box">
      <img src="logo.png" alt="Logo" style="height: 45px;" />
      <div><h2 style="font-size: 22px;">AGENDA DE REUNIÕES</h2></div>
      <div id="loginForm" style="width: 100%;">
        <div class="form-group"><label for="loginUsername">LOGIN</label><input type="text" id="loginUsername" /></div>
        <div class="form-group"><label for="loginPassword">SENHA</label><input type="password" id="loginPassword" /></div>
        <button class="btn btn-primary" style="width:100%;" onclick="login()">Entrar</button>
        <div id="loginError" class="error"></div>
      </div>
    </div>
  </div>

  <div id="mainScreen" style="display: none;">
    <header>
      <div class="header-logo"><img src="logo.png" alt="Logo" /><h2>Agenda de Salas de Reunião</h2></div>
      <div class="user-info"><span id="userName"></span><span id="userType" class="badge"></span><button onclick="logout()">Sair</button></div>
    </header>

    <div class="tabs">
      <button class="tab-button" id="tabCalendario" onclick="showTab('calendario')">Calendário</button>
      <button class="tab-button active" id="tabSalas" onclick="showTab('salas')">Salas</button>
      <button class="tab-button" id="tabRelatorio" onclick="showTab('relatorio')" style="display: none;">Relatório</button>
    </div>
    
    <div id="calendarioView" class="view"><div id="calendar"></div></div>
    
    <div id="salasView" class="view active">
      <div class="filtros-container" style="grid-template-columns: 1fr; max-width: 300px; margin-bottom: 20px;">
        <div class="form-group" style="margin: 0;">
          <label for="statusFiltro">Filtrar por Status:</label>
          <select id="statusFiltro" onchange="loadMeetings()">
            <option value="">Todas</option>
            <option value="pendente">Pendentes</option>
            <option value="concluida">Concluídas</option>
          </select>
        </div>
      </div>
      <div class="rooms-container">
        <div class="room-card">
          <div class="room-header">
            <h2 class="room-title">Sala de Baixo</h2>
            <button class="btn btn-primary btn-agendar" onclick="openMeetingModal('baixo')" style="display: none;">+ Agendar</button>
          </div>
          <div class="room-content" id="meetingsBaixo"></div>
        </div>
        <div class="room-card">
          <div class="room-header">
            <h2 class="room-title">Sala de Cima</h2>
            <button class="btn btn-primary btn-agendar" onclick="openMeetingModal('cima')" style="display: none;">+ Agendar</button>
          </div>
          <div class="room-content" id="meetingsCima"></div>
        </div>
      </div>
    </div>

    <div id="relatorioView" class="view">
      <div class="filtros-container">
        <div class="form-group"><label for="dataInicio">Data Início:</label><input type="date" id="dataInicio"></div>
        <div class="form-group"><label for="dataFim">Data Fim:</label><input type="date" id="dataFim"></div>
        <div class="form-group"><label for="salaRelatorio">Sala:</label><select id="salaRelatorio"><option value="todas">Todas</option><option value="baixo">Sala de Baixo</option><option value="cima">Sala de Cima</option></select></div>
        <div class="form-group"><button class="btn btn-primary" style="width:100%;" onclick="carregarDadosRelatorio()">Carregar</button></div>
        <div class="form-group"><button class="btn" style="background-color:var(--success-color); color:white; width:100%;" onclick="exportarParaExcel()">Exportar CSV</button></div>
        <div class="form-group"><button class="btn" style="background-color:#ff9800; color:white; width:100%;" onclick="exportarParaHTML()">Exportar HTML</button></div>
      </div>
      <div id="resultadoRelatorio" class="relatorio-container">
        <div class="state-message"><i class="fas fa-filter"></i><p>Clique em "Carregar" para ver o histórico completo ou use os filtros para refinar a busca.</p></div>
      </div>
    </div>
  </div>

  <div id="meetingModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2 id="modalTitle"></h2><span class="close" onclick="closeMeetingModal()">&times;</span></div>
      <form id="meetingForm" onsubmit="event.preventDefault(); saveMeeting();">
        <div class="form-row">
            <div class="form-group"><label for="meetingRoom">Sala *</label><select id="meetingRoom" required><option value="baixo">Sala de Baixo</option><option value="cima">Sala de Cima</option></select></div>
            <div class="form-group"><label for="meetingDepartment">Departamento *</label><select id="meetingDepartment" required></select></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label for="meetingDate">Data *</label><input type="date" id="meetingDate" required /></div>
          <div class="form-group"><label for="meetingParticipants">Nº de Participantes *</label><input type="number" id="meetingParticipants" min="1" oninput="gerarCamposParticipantes()" required /></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label for="meetingStartTime">Início *</label><input type="time" id="meetingStartTime" required /></div>
          <div class="form-group"><label for="meetingEndTime">Fim *</label><input type="time" id="meetingEndTime" required /></div>
        </div>
        <div class="form-group"><label for="meetingSubject">Assunto da Reunião *</label><textarea id="meetingSubject" rows="3" required></textarea></div>
        <div class="form-group"><label>Nomes dos Participantes</label><div id="participantesContainer" class="participantes-container"></div></div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" class="btn btn-primary">Salvar</button>
          <button type="button" class="btn" style="background-color: #555; color: white;" onclick="closeMeetingModal()">Cancelar</button>
        </div>
        <div id="meetingError" class="error"></div>
      </form>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
    const api = axios.create({ baseURL: '/api' });
    let currentUser = null;
    let currentMeetingId = null;
    let calendar = null;
    let departments = [];

    api.interceptors.request.use(config => {
      const token = localStorage.getItem('token');
      if (token) config.headers.Authorization = `Bearer ${token}`;
      return config;
    });
    api.interceptors.response.use(r => r, e => {
      if (e.response?.status === 401) logout(true);
      return Promise.reject(e);
    });

    window.addEventListener('load', () => {
      if (localStorage.getItem('token')) verifyToken();
      else document.getElementById('loginScreen').style.display = 'flex';
    });

    async function login() {
      const [username, password, errorDiv] = [document.getElementById('loginUsername').value, document.getElementById('loginPassword').value, document.getElementById('loginError')];
      errorDiv.textContent = '';
      try {
        const response = await api.post('/login', { username, password });
        localStorage.setItem('token', response.data.token);
        currentUser = response.data.user;
        await initializeUI();
      } catch (error) { errorDiv.textContent = error.response?.data?.error || 'Credenciais inválidas.'; }
    }

    async function verifyToken() {
      try {
        const response = await api.get('/verify');
        currentUser = response.data.user;
        await initializeUI();
      } catch { logout(true); }
    }

    async function initializeUI() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainScreen').style.display = 'block';
        document.getElementById('userName').textContent = currentUser.name;
        
        const userTypeSpan = document.getElementById('userType');
        userTypeSpan.textContent = currentUser.user_type.toUpperCase();
        userTypeSpan.className = `badge ${currentUser.user_type}`;
        
        if (currentUser.user_type === 'admin') {
            document.getElementById('tabRelatorio').style.display = 'block';
            document.querySelectorAll('.btn-agendar').forEach(btn => btn.style.display = 'block');
            await loadDepartments();
        } else {
            document.getElementById('tabRelatorio').style.display = 'none';
            document.querySelectorAll('.btn-agendar').forEach(btn => btn.style.display = 'none');
        }
        showTab('salas');
        initCalendar();
        loadMeetings();
    }
    
    function logout(isSessionExpired = false) {
      if (!isSessionExpired && !confirm('Tem certeza que deseja sair?')) return;
      localStorage.removeItem('token');
      window.location.reload();
    }

    function showTab(tabId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(`${tabId}View`).classList.add('active');
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).classList.add('active');
        if (tabId === 'calendario' && calendar) setTimeout(() => calendar.render(), 10);
        if (tabId === 'salas') loadMeetings();
    }
    
    function initCalendar() {
      if (calendar) calendar.destroy();
      calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'dayGridMonth', locale: 'pt-br',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
        buttonText: { today: 'Hoje', month: 'Mês', week: 'Semana', list: 'Agenda' },
        events: (fetchInfo, successCallback, failureCallback) => {
          api.get('/meetings').then(res => {
            successCallback(res.data.map(m => ({
                id: m.id, 
                title: m.subject, 
                start: `${m.date}T${m.start_time}`, 
                end: `${m.date}T${m.end_time}`,
                backgroundColor: m.computed_status === 'concluida' ? 'var(--success-color)' : 'var(--primary-color)',
                borderColor: m.computed_status === 'concluida' ? 'var(--success-color)' : 'var(--primary-color)',
                textColor: 'white',
                extendedProps: m
            })));
          }).catch(failureCallback);
        },
        eventContent: function(arg) {
          let html = '';
          const title = `<div>${arg.event.title}</div>`;
          const time = `<div>${arg.timeText}</div>`;

          if (arg.view.type.includes('Grid')) { // dayGridMonth, timeGridWeek
              html = `<div style="overflow: hidden; font-size: 0.85em; padding: 2px;">
                          <strong>${arg.timeText}</strong> ${arg.event.title}
                      </div>`;
          } else if (arg.view.type === 'listWeek') {
              html = `<strong>${arg.event.title}</strong>`;
          } else {
              html = `<b>${arg.timeText}</b> ${arg.event.title}`;
          }
          return { html: html };
        },
        eventClick: (info) => {
          const props = info.event.extendedProps;
          let msg = `Assunto: ${props.subject}\n` +
                    `Sala: ${props.room_location === 'baixo' ? 'Sala de Baixo' : 'Sala de Cima'}\n` +
                    `Departamento: ${props.department.charAt(0).toUpperCase() + props.department.slice(1)}\n` +
                    `Horário: ${props.start_time} - ${props.end_time}\nOrganizador: ${props.organizer_name}\n` +
                    `Participantes: ${props.participants_names || 'Não informado'}`;
          alert(msg);
        }
      });
      calendar.render();
    }


    async function loadMeetings() {
        const status = document.getElementById('statusFiltro').value;
        const params = { status };
        try {
            const response = await api.get('/meetings', { params });
            renderMeetingsInContainer(document.getElementById('meetingsBaixo'), response.data.filter(m => m.room_location === 'baixo'));
            renderMeetingsInContainer(document.getElementById('meetingsCima'), response.data.filter(m => m.room_location === 'cima'));
            if (calendar) calendar.refetchEvents();
        } catch (error) {
            console.error('Erro ao carregar reuniões:', error);
            const errorHtml = `<div class="state-message"><i class="fas fa-exclamation-triangle"></i><p>Falha ao carregar.</p></div>`;
            document.getElementById('meetingsBaixo').innerHTML = errorHtml;
            document.getElementById('meetingsCima').innerHTML = errorHtml;
        }
    }

function renderMeetingsInContainer(container, meetings) {
    if (!meetings || meetings.length === 0) {
        container.innerHTML = '<div class="state-message"><i class="far fa-calendar-check"></i><p>Nenhuma reunião encontrada.</p></div>'; 
        return;
    }
    container.innerHTML = meetings.map(meeting => {
        const isConcluded = meeting.computed_status === 'concluida';
        const isDeleted = meeting.status === 'excluida';
        const canEdit = currentUser.user_type === 'admin';
        
        let statusBadge = '';
        let borderColor = 'var(--primary-color)';
        if (isDeleted) {
            statusBadge = '<span class="meeting-status" style="background-color: #999; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px;">EXCLUÍDA</span>';
            borderColor = '#999';
        } else if (isConcluded) {
            statusBadge = '<span class="meeting-status" style="background-color: var(--success-color); color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px;">CONCLUÍDA</span>';
            borderColor = 'var(--success-color)';
        }

        return `<div class="meeting-item" style="border-left-color: ${borderColor};">
            <div class="meeting-header">
                <div class="meeting-time">
                    ${formatDate(meeting.date)} - ${meeting.start_time} às ${meeting.end_time}
                    ${statusBadge}
                </div>
                ${canEdit && !isDeleted ? `
                <div class="meeting-actions">
                    ${!isConcluded ? `<button class="btn btn-primary btn-small" onclick="openMeetingModal(null, ${meeting.id})">Editar</button>` : ''}
                    <button class="btn btn-small" style="background-color: var(--danger-color); color: white;" onclick="deleteMeeting(${meeting.id})">Excluir</button>
                </div>` : ''}
            </div>
            <div class="meeting-details">
                <div><strong>Assunto:</strong> ${meeting.subject}</div>
                <div><strong>Depto:</strong> ${meeting.department.charAt(0).toUpperCase() + meeting.department.slice(1)}</div>
                <div><strong>Organizador:</strong> ${meeting.organizer_name}</div>
                <div><strong>Participantes:</strong> ${meeting.participants_names || 'Não informado'}</div>
            </div>
        </div>`;
    }).join('');
}
    async function openMeetingModal(room, meetingId = null) {
      currentMeetingId = meetingId;
      document.getElementById('meetingForm').reset();
      document.getElementById('participantesContainer').innerHTML = '';
      document.getElementById('meetingError').textContent = '';
      try {
        if (meetingId) {
            document.getElementById('modalTitle').textContent = 'Editar Reunião';
            const { data: meeting } = await api.get(`/meetings/${meetingId}`);
            document.getElementById('meetingRoom').value = meeting.room_location;
            document.getElementById('meetingDepartment').value = meeting.department;
            document.getElementById('meetingDate').value = meeting.date;
            document.getElementById('meetingStartTime').value = meeting.start_time;
            document.getElementById('meetingEndTime').value = meeting.end_time;
            document.getElementById('meetingSubject').value = meeting.subject;
            document.getElementById('meetingParticipants').value = meeting.participants;
            gerarCamposParticipantes();
            if (meeting.participants_names) {
                meeting.participants_names.split(',').forEach((nome, i) => {
                    const el = document.getElementById(`participante_${i + 1}`);
                    if (el) el.value = nome.trim();
                });
            }
        } else {
            document.getElementById('modalTitle').textContent = 'Nova Reunião';
            document.getElementById('meetingRoom').value = room;
            document.getElementById('meetingDate').valueAsDate = new Date();
        }
        document.getElementById('meetingModal').style.display = 'block';
      } catch(error) { alert('Não foi possível carregar os dados da reunião.'); }
    }

    function closeMeetingModal() { document.getElementById('meetingModal').style.display = 'none'; }

async function saveMeeting() {
  const errDiv = document.getElementById('meetingError');
  errDiv.textContent = '';
  const data = {
    room_location: document.getElementById('meetingRoom').value,
    department: document.getElementById('meetingDepartment').value,
    date: document.getElementById('meetingDate').value,
    start_time: document.getElementById('meetingStartTime').value,
    end_time: document.getElementById('meetingEndTime').value,
    subject: document.getElementById('meetingSubject').value.trim(),
    participants: parseInt(document.getElementById('meetingParticipants').value, 10),
    participants_names: Array.from({ length: parseInt(document.getElementById('meetingParticipants').value, 10) || 0 }, (_, i) => document.getElementById(`participante_${i + 1}`)?.value.trim()).join(', ')
  };

  if (!data.subject || !data.date || !data.start_time || !data.end_time || !data.department) {
    errDiv.textContent = 'Por favor, preencha todos os campos obrigatórios.';
    return;
  }
  if (data.start_time >= data.end_time) {
    errDiv.textContent = 'O horário de término deve ser após o de início.';
    return;
  }

  try {
    const method = currentMeetingId ? 'put' : 'post';
    const url = currentMeetingId ? `/meetings/${currentMeetingId}` : '/meetings';
    await api[method](url, data);
    closeMeetingModal();
    loadMeetings();
  } catch (error) {
    if (error.response?.status === 409) {
      errDiv.textContent = error.response.data.error;
    } else {
      errDiv.textContent = error.response?.data?.error || 'Ocorreu um erro ao salvar.';
    }
  }
}

    async function deleteMeeting(id) {
      if (!confirm('Deseja mesmo excluir esta reunião? A ação não pode ser desfeita.')) return;
      try {
        await api.delete(`/meetings/${id}`);
        loadMeetings();
      } catch (error) { alert(error.response?.data?.error || 'Erro ao excluir.'); }
    }

    async function carregarDadosRelatorio() {
      const resultadoDiv = document.getElementById('resultadoRelatorio');
      resultadoDiv.innerHTML = `<div class="state-message"><i class="fas fa-spinner fa-spin"></i><p>Carregando...</p></div>`;
      try {
        const params = {
          dataInicio: document.getElementById('dataInicio').value,
          dataFim: document.getElementById('dataFim').value,
          sala: document.getElementById('salaRelatorio').value,
        };
        const { data: meetings } = await api.get('/meetings/historico', { params });
        if (!meetings || meetings.length === 0) {
          resultadoDiv.innerHTML = `<div class="state-message"><i class="fas fa-table"></i><p>Nenhuma reunião encontrada com os filtros selecionados.</p></div>`;
          return;
        }
        let html = `<p style="margin-bottom: 15px;">${meetings.length} reuniões encontradas.</p>
          <table class="tabela-relatorio"><thead><tr><th>Data</th><th>Horário</th><th>Sala</th><th>Departamento</th><th>Assunto</th><th>Organizador</th><th>Participantes</th><th>Status</th></tr></thead><tbody>`;
        meetings.forEach(m => {
          html += `<tr>
              <td>${formatDate(m.date)}</td>
              <td>${m.start_time} - ${m.end_time}</td>
              <td>${m.room_location === 'baixo' ? 'Sala de Baixo' : 'Sala de Cima'}</td>
              <td>${m.department ? (m.department.charAt(0).toUpperCase() + m.department.slice(1)) : '-'}</td>
              <td>${m.subject}</td>
              <td>${m.organizer_name}</td>
              <td>${m.participants_names || '-'}</td>
              <td>${m.status_display}</td>
            </tr>`;
        });
        html += `</tbody></table>`;
        resultadoDiv.innerHTML = html;
      } catch (error) {
        console.error('Erro ao carregar relatório:', error);
        resultadoDiv.innerHTML = `<div class="state-message" style="color:var(--danger-color);"><i class="fas fa-exclamation-triangle"></i><p>${error.response?.data?.error || 'Erro ao carregar relatório'}</p></div>`;
      }
    }

    async function exportarParaExcel() {
      const params = {
          dataInicio: document.getElementById('dataInicio').value,
          dataFim: document.getElementById('dataFim').value,
          sala: document.getElementById('salaRelatorio').value
      };
      try {
        const response = await api.get('/meetings/exportar', { 
            params, responseType: 'blob' 
        });
        const url = window.URL.createObjectURL(new Blob([response.data]));
        const link = document.createElement('a');
        link.href = url;
        const today = new Date().toISOString().split('T')[0];
        link.setAttribute('download', `relatorio_reunioes_${today}.csv`);
        document.body.appendChild(link);
        link.click();
        setTimeout(() => {
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
        }, 100);
      } catch (error) {
        console.error('Erro ao exportar:', error);
        alert('Não foi possível exportar o relatório. Verifique os filtros e tente novamente.');
      }
    }

    async function exportarParaHTML() {
      const params = {
          dataInicio: document.getElementById('dataInicio').value,
          dataFim: document.getElementById('dataFim').value,
          sala: document.getElementById('salaRelatorio').value
      };
      try {
        const response = await api.get('/meetings/exportar_html', { 
            params, responseType: 'blob' 
        });
        const url = window.URL.createObjectURL(new Blob([response.data], { type: 'text/html' }));
        const link = document.createElement('a');
        link.href = url;
        const today = new Date().toISOString().split('T')[0];
        link.setAttribute('download', `relatorio_reunioes_${today}.html`);
        document.body.appendChild(link);
        link.click();
        setTimeout(() => {
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
        }, 100);
      } catch (error) {
        console.error('Erro ao exportar HTML:', error);
        alert('Não foi possível exportar o relatório em HTML. Verifique os filtros e tente novamente.');
      }
    }

    function gerarCamposParticipantes() {
      const num = parseInt(document.getElementById('meetingParticipants').value, 10) || 0;
      const container = document.getElementById('participantesContainer');
      container.innerHTML = Array.from({ length: num }, (_, i) => `<div class="form-group" style="margin-bottom:0.5rem;"><input type="text" id="participante_${i+1}" placeholder="Nome do participante ${i+1}" /></div>`).join('');
    }

    async function loadDepartments() {
      try {
        const { data: depts } = await api.get('/departments');
        departments = depts;
        const select = document.getElementById('meetingDepartment');
        select.innerHTML = '<option value="">Selecione um departamento...</option>' + departments.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
      } catch (error) { console.error('Erro ao carregar departamentos:', error); }
    }

    function formatDate(dateStr) { return new Date(dateStr + 'T00:00:00').toLocaleDateString('pt-BR'); }
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMeetingModal(); });
    window.addEventListener('click', (e) => { if (e.target == document.getElementById('meetingModal')) closeMeetingModal(); });

setInterval(loadMeetings, 60000); // Atualiza reuniões a cada 60 segundos
</script>
</body>
</html>